<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>请求测试</title>
    <script type="text/javascript" src="../js/jquery.min.js"></script>
    <script type="text/javascript" src="../js/crypto-js/core.js"></script>
    <script type="text/javascript" src="../js/crypto-js/lib-typedarrays.js"></script>
    <script type="text/javascript" src="../js/crypto-js/x64-core.js"></script>
    <script type="text/javascript" src="../js/crypto-js/hmac.js"></script>
    <script type="text/javascript" src="../js/crypto-js/hmac-sha1.js"></script>
    <script type="text/javascript" src="../js/crypto-js/sha1.js"></script>
    <script type="text/javascript" src="../js/crypto-js/md5.js"></script>
    <script type="text/javascript" src="../js/crypto-js/enc-base64.js"></script>
    
    <script type="text/javascript">

    $(function(){
    	var timeStamp = new Date().getTime();
        $('#header_timeStamp_value').val(timeStamp);
        
        $('#sendButton').click(function () {
            var method = $('select').val();
            var url = $('#url').val();
            var client = $('#header_client_value').val();
            var secret = $('#header_secret_value').val();
            var body = $('#body').val();
            if (!$('#header_timeStamp_value').val()) {
                $('#header_timeStamp_value').val(new Date().getTime())
            }

            var timestamp = $('#header_timeStamp_value').val();

            var headers = [];
            $('.header').each(function (index,header) {
                var header_key = $(header).find('.header_key').val();
                var header_value = $(header).find('.header_value').val();
                if (''!=header_key && (header_key.indexOf('X-Co-')==0 || 'ut' == header_key)){
                    var header_obj = new Object();
                    header_obj.key = header_key;
                    header_obj.value = header_value;
                    headers.push(header_obj);
                }
            });

            var signVersion = $('#signVersion').val();

            if(method.length==0 || client.length ==0 || secret.length==0 || url.length==0 || timestamp.length==0){
            	alert("paramError!!!");
            }else{

                var sign = '';
                if (1 == signVersion){
                    sign = getSignV1(method,url,client,secret,timestamp,body);
                } else if (2 == signVersion){
                    sign = getSignV2(method,url,headers,body,secret);
                }
                $('#header_sign_value').val(sign);
            	postmethod(url,method,headers,body);
            }

        });
    });

    function getSignV1(method,url,client,secret,timestamp,body){
    	var msg = method+'\n';

    	//if(){} //requestParameter
        if(url.indexOf("?") != -1){
            msg = msg + GetUrlParams(url);
        }else {
            msg = msg + url;
        }
    	msg = msg+'\n'+'x-co-client:'+client+'\n'+'x-co-timestamp:'+timestamp;
        if(body){
            var md5Body = CryptoJS.MD5(body)+'';
            md5Body = md5Body.toUpperCase();
            msg = msg+'\n'+md5Body;
        }
        var signSha1 = CryptoJS.HmacSHA1(msg,secret);
        //alert(signStr);
//        var signWA = CryptoJS.enc.Utf8.parse(signStr.toString().toUpperCase()); 
//        signStr = CryptoJS.enc.Base64.stringify(signWA);
        var signStr = CryptoJS.enc.Base64.stringify(signSha1);
        //alert(signStr+"333");
        return signStr;
    }

    function getSignV2(method,url,headers,body,secret){
        var msg = method+'\n';

        //if(){} //requestParameter
        if(url.indexOf("?") != -1){
            msg = msg + GetUrlParams(url);
        }else {
            msg = msg + url;
        }

        msg += '\n'+SortHeaders(headers);

        if(body){
            var md5Body = CryptoJS.MD5(body)+'';
            md5Body = md5Body.toUpperCase();
            msg = msg+'\n'+md5Body;
        }
        var signSha1 = CryptoJS.HmacSHA1(msg,secret);
        //alert(signStr);
//        var signWA = CryptoJS.enc.Utf8.parse(signStr.toString().toUpperCase());
//        signStr = CryptoJS.enc.Base64.stringify(signWA);
        var signStr = CryptoJS.enc.Base64.stringify(signSha1);
        //alert(signStr+"333");
        return signStr;
    }

    function postmethod(url,method,headers,body) {

        var contentType = 'application/json';
        if('GET' == method){
            body=null;
            contentType = 'application/x-www-form-urlencoded';
        }

        $.ajax({
            type:method,
            url:url,
            beforeSend: function(xhr) {
                $.each(headers,function (i,header) {
                    xhr.setRequestHeader(header.key,header.value);
                });
            },
            dataType:'text',
            contentType:contentType,
            data:body,
            success:function (data) {
                console.log(data);
                $('#return').val(data);
            }
        })
    }

    function SortHeaders(headers) {
        var map = {};
        var keys = new Array();
        $.each(headers,function (i,header) {
            map[header.key.toLowerCase()]=header.value;
            keys[i]=header.key.toLowerCase();
        })

        var header_str = '';
        var keys = keys.sort();
        $.each(keys,function (i,key) {
            if (key != 'X-Co-sign'.toLowerCase()){
                header_str += '\n'+key+':'+map[key];
            }
        })

        header_str = header_str.substr(1);
        return header_str;
    }

    //获取地址栏里（URL）传递的参数
    function GetUrlParams(url) {
        var map = {};
        var params = "";
        var keys = new Array();
        if(url.indexOf("?") != -1)//url中存在问号，也就说有参数。
        {
            var uri = url.substr(0,url.indexOf('?'));
            var str = url.substr(url.indexOf("?")+1); //得到?后面的字符串
            var strs = str.split("&"); //将得到的参数分隔成数组

            for(var i = 0; i < strs.length; i ++)
            {
                var parm = strs[i].split("=");

                map[parm[0]]=parm[1];
                keys[i]=parm[0];
            }
            var keys = keys.sort();//key值排序，重组参数顺序
            for(var i=0; i< keys.length;i++){
                params = params + "&" + keys[i] +"=" + encodeURI(map[keys[i]]);
            }
        }
        return uri+'\n'+ params.substr(1);
    }

     function addHeader() {
         var headerTemp = $('#addHeaderBtn').next().clone(true).show();
         $('#addHeaderBtn').before(headerTemp);
     }

    function deleteHeader(obj) {
        $(obj).parent().parent().remove();
    }

    </script>
    
</head>
<body>
<table border="0" style="width: 80%; table-layout:fixed;word-break:break-all;">
    <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td style="text-align: right">请求方式：</td>
        <td>
            <select id="method"  style="width: 80%">
                <option>GET</option>
                <option>POST</option>
            </select>
        </td>
    </tr>
    <tr>
        <td style="text-align: right">签名版本：</td>
        <td>
            <select id="signVersion"  style="width: 80%">
                <option value="1">1.0</option>
                <option value="2">2.0</option>
            </select>
        </td>
    </tr>
    <tr>
        <td style="text-align: right">URL *</td>
        <td colspan="3">
            <input name="url" id="url" type="text" style="width:100%;"/>
        </td>
    </tr>
    <tr class="header">
        <td style="text-align: right">
            请求头:
        </td>
        <td>
            <input style="width: 80%;" value="X-Co-Client" class="header_key" readonly></input>
        </td>
        <td colspan="2">
            <input id="header_client_value" class="header_value" style="width:100%;"/>
        </td>
    </tr>
    <tr>
        <td></td>
        <td>
            <input style="width: 80%;" value="Secret" class="header_key" readonly></input>
        </td>
        <td colspan="2">
            <input id="header_secret_value" class="header_value" style="width:100%;"/>
        </td>
    </tr>
    <tr class="header">
        <td></td>
        <td>
            <input style="width: 80%;" value="X-Co-TimeStamp" class="header_key" readonly></input>
        </td>
        <td colspan="2">
            <input id="header_timeStamp_value" class="header_value" style="width:100%;"/>
        </td>
    </tr>
    <tr class="header">
        <td></td>
        <td >
            <input style="width: 80%;" value="X-Co-sign" class="header_key" readonly></input>
        </td>
        <td colspan="2">
            <input id="header_sign_value" class="header_value" style="width:100%;" readonly=true/>
        </td>
    </tr>
    <tr id="addHeaderBtn">
        <td></td>
        <td colspan="3"><input type="button" value="header+" style="width: 100%; background-color: cadetblue;" onclick="addHeader()"></td>
    </tr>
    <tr class="header" style="display: none">
        <td></td>
        <td>
            <input style="width:80%" class="header_key" placeholder="输入header名称"/>
        </td>
        <td colspan="2">
            <input style="width:100%;" class="header_value" placeholder="输入header值" />
        </td>
        <td>
            <input type="button" value="X" onclick="deleteHeader(this)" style="background-color: darkgrey;"/>
        </td>
    </tr>
    <tr>
        <td style="vertical-align: initial;text-align: right">请求体</td>
        <td colspan="3">
            <textarea style="width: 100%; height: 200px" id="body"></textarea>
        </td>
    </tr>
    <tr>
        <td></td>
        <td colspan="3">
            <button id="sendButton" style="width: 100%;background-color: orangered;">submit</button>
        </td>
    </tr>
    <tr>
        <td style="vertical-align: initial;text-align: right">返回</td>
        <td colspan="3">
            <textarea style="width: 100%; height: 200px" id="return"></textarea>
        </td>
    </tr>
</table>
<!-- <script src="../js/test/openTest.js"></script> -->
</body>
</html>
